dependencies:
  post:
    - npm install -g uglifyjs
    - pip install selenium
    - wget https://saucelabs.com/downloads/sc-latest-linux.tar.gz
    - tar -xzf sc-latest-linux.tar.gz
    - wget https://github.com/mozilla/geckodriver/releases/download/v0.11.1/geckodriver-v0.11.1-linux64.tar.gz
    - tar -xvzf geckodriver-v0.11.1-linux64.tar.gz
test:
  override:
    # First start the tunnel because it takes time to setup.
    - cd sc-*-linux && ./bin/sc --user $SAUCE_USERNAME --api-key $SAUCE_ACCESS_KEY --readyfile ~/sauce_is_ready --tunnel-identifier numeric-$CIRCLE_BUILD_NUM:
        background: true
    # Build and test locally.
    - ./tools/build.sh
    # Server files.
    - python ./tools/serve.py:
        background: true
    # Wait for server to be ready.
    - curl --retry 10 --retry-delay 2 -s http://localhost:8000/ > /dev/null
    # Run selenium tests.
    - python ./tools/selenium_tests.py Chrome http://localhost:8000/
    - PATH=.:$PATH ; python ./tools/selenium_tests.py Firefox http://localhost:8000/
    # Wait for tunnel to be ready.
    - while [ ! -e ~/sauce_is_ready ]; do sleep 1; done
    # TODO: We should upgrade to HTTPS once selenium Python package is released with this pull request: https://github.com/SeleniumHQ/selenium/pull/3179
    - SELENIUM_REMOTE_CAPABILITIES="{\"browserName\":\"internet explorer\",\"platform\":\"Windows 10\",\"version\":\"11.103\",\"name\":\"numeric\",\"build\":\"$CIRCLE_BUILD_NUM\",\"tunnelIdentifier\":\"numeric-$CIRCLE_BUILD_NUM\"}" SELENIUM_REMOTE_URL=http://$SAUCE_USERNAME:$SAUCE_ACCESS_KEY@ondemand.saucelabs.com:80/wd/hub python ./tools/selenium_tests.py Remote http://localhost:8000/
  post:
    # Wait for Sauce Connect to close the tunnel.
    - killall --wait sc
    - killall --wait python
